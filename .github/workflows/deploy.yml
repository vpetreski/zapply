name: Deploy to Synology NAS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{github.repository_owner}}/zapply-backend
  FRONTEND_IMAGE_NAME: ${{github.repository_owner}}/zapply-frontend

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{env.REGISTRY}}
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{env.REGISTRY}}/${{env.BACKEND_IMAGE_NAME}}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: ${{steps.meta-backend.outputs.tags}}
          labels: ${{steps.meta-backend.outputs.labels}}

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{env.REGISTRY}}/${{env.FRONTEND_IMAGE_NAME}}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          tags: ${{steps.meta-frontend.outputs.tags}}
          labels: ${{steps.meta-frontend.outputs.labels}}

  deploy:
    name: Deploy to NAS
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{secrets.NAS_SSH_KEY}}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 192.168.0.188 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to NAS
        env:
          NAS_HOST: 192.168.0.188
          NAS_USER: admin
        run: |
          # Copy deployment files to NAS
          scp -i ~/.ssh/id_rsa docker-compose.prod.yml ${NAS_USER}@${NAS_HOST}:/volume1/docker/zapply/
          scp -i ~/.ssh/id_rsa scripts/deploy.sh ${NAS_USER}@${NAS_HOST}:/volume1/docker/zapply/scripts/

          # Execute deployment script on NAS
          ssh -i ~/.ssh/id_rsa ${NAS_USER}@${NAS_HOST} bash << 'ENDSSH'
            cd /volume1/docker/zapply
            export GITHUB_REPOSITORY_OWNER=${{github.repository_owner}}
            export IMAGE_TAG="latest"
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh
ENDSSH

      - name: Verify deployment
        env:
          NAS_HOST: 192.168.0.188
          NAS_USER: admin
        run: |
          echo "Waiting for services to start..."
          sleep 30

          # Check if services are running
          ssh -i ~/.ssh/id_rsa ${NAS_USER}@${NAS_HOST} \
            "cd /volume1/docker/zapply && docker-compose -f docker-compose.prod.yml ps"

      - name: Deployment summary
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸ“ Frontend: http://192.168.0.188:3000"
          echo "ðŸ“ QuickConnect: https://192-168-0-188.vpetreski.direct.quickconnect.to:3000"
